{% extends 'base.html' %}
{% load comments %}
{% load voting_tags %}


{% block title %}{{ chapter.title }}{% endblock %}

{% block content %}
<div class="chapter clearfix">
    <h1 class="title">{{ chapter.title }}</h1>
    
     <p class="author meta">
       By {{ chapter.author.get_full_name }}
     </p>
    
    <div class="body">
        {{ chapter.body_html|safe }}
    </div>   
    
    <p class="meta">
       This chapter was last updated: {{ chapter.mod_date|timesince }} ago.
     </p>
     
    
    <h2>Your rating:</h2>
    
    <div id="rating">       
     <form id="rating-widget" action="{% url rate-chapter chapter.id %}" method="post">
             {% csrf_token %}
             <select name="score">             
             {% for value, label in options %}             
                 <option value="{{ value }}" {% ifequal score value %}selected="selected"{% endifequal %}>{{ label }}</option>
             {% endfor %}
            </select>          
            <input type="submit" value="Rate it!" />
      </form></div>
  
  
    <p><a href="{% url all_chapters %}">Read more chapters</a></p>
     
</div>


<div id="comments">

    <h2 class="section-title">Feedback</h2>
{% get_comment_list for chapter as comment_list %}
{% for comment in comment_list %}

    {% score_for_object comment as score %}
    {% vote_by_user user on comment as vote %}
    <div id="c{{ comment.id }}" class="comment clearfix">        
            


        <div class="grid_4 alpha">
            <h3 class="title">{{ comment.user_name }}:</h3>
            
            <p class="content">{{ comment.comment }}</p>
            <p class="meta">          
                <span class="submitted">
                    Submitted {{ comment.submit_date|timesince }} ago
                </span>
            </p>          
        </div>    
            <div class="grid_3 omega vote clearfix">
              <div class="options">
                <span class="vote-up {% if vote and vote.is_upvote %}vote-on{% endif %}" title="This input is useful (click again to undo)">Yay!!!</span>
                
                <span class="vote-down {% if vote and vote.is_downvote %}vote-on{% endif %}" title="This input is not useful (click again to undo)">Meh...</span>
              
              </div>
              
              <div class="status">
                <span class="vote-score">{{ score.score }}</span>
              </div>
                            
            </div>        
    </div>
    
{% endfor %}


  <h2 class="section-title">What do you think about this chapter?</h2>
<div id="comment-form">


{% if user.is_authenticated %}
    {% get_comment_form for chapter as form %}
    <form action="{% comment_form_target %}" method="post">
        {% csrf_token %}
        <input name="next" type="hidden" value="{% url book.views.chapter chapter.pk %}" />
        {% for field in form %}
            {% if field.is_hidden %}
                {{ field }}
            {% else %}
                {% if field.name != "name" and field.name != "email" and field.name != "url" %}
                    
                    <p {% ifequal field.name "honeypot" %} style="display:none;"{% endifequal %}>
                
                    {% if field.errors %}{{ field.errors }}{% endif %}
                    {{ field }}
                    </p>
                {% endif %}
            {% endif %}
        {% endfor %}
        <input class="submit-post" name="post" type="submit" value="Share your feedback" />
    </form>
{% else %}
    Log in or register to comment!
{% endif %}
</div>

</div>
    
{% endblock %}